on: push
name: deploy
jobs:
        deploy:
                name: deploy to server
                runs-on: ubuntu-latest
                steps:
                        - uses: actions/checkout@master
                        - name: build and push to docker
                          uses: docker/build-push-action@v1
                          with:
                                  username: ${{ secrets.DOCKER_USERNAME }}
                                  password: ${{ secrets.DOCKER_PASSWORD }}
                                  repository: ${{ github.repository  }}
                                  tag_with_ref: true
                                  tag_with_sha: true
                                  tags: ${{ github.sha }}
                        
                        - name: ssh pipelines
                          uses: cross-the-world/ssh-pipeline@master
                          env: 

                                MESSAGE: "container updated"     
                                DOCKER_IMAGE: ${{ github.repository }}
                                CONTAINER: ${{ secrets.CONTAINER }}
                                NEW_PORT: ${{ secrets.NEW_PORT  }}

                          with:
                               
                                host: ${{ secrets.MT_HOST }}
                                user: ${{ secrets.MT_USER }}
                                pass: ${{ secrets.MT_PASS }}
                                port: ${{ secrets.MT_PORT }}
                                connect_timeout: 10s
                                script: |
                                  docker pull $DOCKER_IMAGE
                                  docker stop $CONTAINER
                                  docker rm $CONTAINER
                                  docker run --name $CONTAINER -d -p $NEW_PORT:80 $DOCKER_IMAGE
                                  rm test.txt
                                  date >> test.txt
                                  echo $MESSAGE >> test.txt


